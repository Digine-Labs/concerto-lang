// schema_retry_fallback
// Demonstrates trial/error with a lower-capability model and explicit fallback
// when structured output validation keeps failing.

schema IncidentReport {
    severity: "low" | "medium" | "high" | "critical",
    component: String,
    summary: String,
    action_items: Array<String>,
    confidence: Int,
}

@retry(max: 2, backoff: "none")
agent NoisyExtractor {
    provider: openai,
    model: "cheap",
    temperature: 1.3,
    max_tokens: 700,
    system_prompt: "Extract incident data, but model quality is intentionally limited.",
}

@retry(max: 2, backoff: "linear")
agent ReliableExtractor {
    provider: openai,
    model: "robust",
    temperature: 0.1,
    max_tokens: 900,
    system_prompt: "Return strict JSON matching the schema exactly.",
}

fn extract_with_recovery(ticket: String) -> Result<IncidentReport, String> {
    let mut attempt = 1;
    let max_noisy_attempts = 2;
    let mut last_noisy_error = "none";

    while attempt <= max_noisy_attempts {
        let noisy_prompt = """
            Parse this incident note into strict JSON:
            ${ticket}

            Return JSON that matches IncidentReport exactly.
            """;

        let noisy_result = NoisyExtractor.execute_with_schema<IncidentReport>(noisy_prompt);
        match noisy_result {
            Ok(report) => {
                emit("noisy_success", {
                    "attempt": attempt,
                    "model": "cheap",
                    "severity": report.severity,
                });
                return Ok(report);
            },
            Err(e) => {
                last_noisy_error = e.message;
                emit("noisy_failure", {
                    "attempt": attempt,
                    "model": "cheap",
                    "error": e.message,
                });
                attempt = attempt + 1;
            },
        }
    }

    emit("fallback", {
        "reason": "Noisy model did not satisfy schema",
        "last_error": last_noisy_error,
        "fallback_model": "robust",
    });

    let fallback_prompt = """
        The weaker model failed to satisfy schema constraints.

        Last failure:
        ${last_noisy_error}

        Re-parse this incident note and return strict JSON:
        ${ticket}
        """;

    let fallback_result = ReliableExtractor.execute_with_schema<IncidentReport>(fallback_prompt);
    match fallback_result {
        Ok(report) => Ok(report),
        Err(e) => Err(
            "Fallback extractor failed. Last noisy error: ${last_noisy_error}. Fallback error: ${e.message}"
        ),
    }
}

fn main() {
    let tickets = [
        "[INC-401] API gateway latency spiked to 8s for 12 minutes; customer checkout retries failed.",
        "[INC-402] Background worker crashed after malformed webhook payload; queue depth reached 28k.",
        "[INC-403] Secrets rotation changed token format and auth requests started failing intermittently.",
    ];

    for ticket in tickets {
        match extract_with_recovery(ticket) {
            Ok(report) => {
                emit("incident_report", {
                    "severity": report.severity,
                    "component": report.component,
                    "summary": report.summary,
                    "action_items": report.action_items,
                    "confidence": report.confidence,
                });
            },
            Err(e) => {
                emit("incident_error", {
                    "ticket": ticket,
                    "error": e,
                });
            },
        }
    }
}
